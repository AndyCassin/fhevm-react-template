<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Confidential Patent License Platform</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/5.7.2/ethers.umd.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #06b6d4 0%, #3b82f6 50%, #8b5cf6 100%);
            min-height: 100vh;
            color: #333;
            overflow-x: hidden;
        }

        /* Animated background particles */
        .background-particles {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            overflow: hidden;
            z-index: 0;
            pointer-events: none;
        }

        .particle {
            position: absolute;
            background: rgba(255, 255, 255, 0.15);
            border-radius: 50%;
            animation: float 15s infinite ease-in-out;
        }

        @keyframes float {
            0%, 100% { transform: translateY(0) translateX(0) rotate(0deg); }
            33% { transform: translateY(-100px) translateX(50px) rotate(120deg); }
            66% { transform: translateY(-50px) translateX(-50px) rotate(240deg); }
        }

        .container {
            position: relative;
            z-index: 1;
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        header {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            padding: 30px;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            margin-bottom: 30px;
            text-align: center;
        }

        h1 {
            color: #06b6d4;
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.1);
        }

        .subtitle {
            color: #3b82f6;
            font-size: 1.2em;
            margin-bottom: 20px;
        }

        .wallet-section {
            background: rgba(255, 255, 255, 0.9);
            padding: 20px;
            border-radius: 15px;
            margin-top: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
        }

        .wallet-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        button {
            background: linear-gradient(135deg, #06b6d4 0%, #3b82f6 100%);
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(6, 182, 212, 0.4);
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(6, 182, 212, 0.6);
        }

        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 30px;
            flex-wrap: wrap;
        }

        .tab-btn {
            flex: 1;
            min-width: 150px;
            padding: 15px;
            background: rgba(255, 255, 255, 0.9);
            color: #06b6d4;
            border: 2px solid #06b6d4;
            border-radius: 15px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            transition: all 0.3s ease;
        }

        .tab-btn.active {
            background: linear-gradient(135deg, #06b6d4 0%, #3b82f6 100%);
            color: white;
            border-color: transparent;
        }

        .tab-content {
            display: none;
            background: rgba(255, 255, 255, 0.95);
            padding: 30px;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        }

        .tab-content.active {
            display: block;
            animation: fadeIn 0.5s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            color: #06b6d4;
            font-weight: bold;
        }

        input, select, textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 14px;
            transition: all 0.3s ease;
        }

        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: #06b6d4;
            box-shadow: 0 0 10px rgba(6, 182, 212, 0.2);
        }

        .card {
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
        }

        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 40px rgba(0, 0, 0, 0.2);
        }

        .card h3 {
            color: #06b6d4;
            margin-bottom: 15px;
            font-size: 1.5em;
        }

        .card-content {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }

        .info-item {
            background: rgba(255, 255, 255, 0.7);
            padding: 10px;
            border-radius: 8px;
        }

        .info-label {
            font-size: 0.85em;
            color: #3b82f6;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .info-value {
            font-size: 1em;
            color: #333;
        }

        .status-badge {
            display: inline-block;
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 0.85em;
            font-weight: bold;
        }

        .status-active {
            background: #4caf50;
            color: white;
        }

        .status-pending {
            background: #ff9800;
            color: white;
        }

        .status-suspended {
            background: #f44336;
            color: white;
        }

        .grid-2 {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #06b6d4;
            font-size: 1.2em;
        }

        .spinner {
            border: 4px solid rgba(6, 182, 212, 0.1);
            border-radius: 50%;
            border-top: 4px solid #06b6d4;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .success-message {
            background: #4caf50;
            color: white;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            display: none;
        }

        .error-message {
            background: #f44336;
            color: white;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            display: none;
        }

        .action-buttons {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-top: 15px;
        }

        .action-buttons button {
            flex: 1;
            min-width: 120px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: linear-gradient(135deg, #06b6d4 0%, #3b82f6 100%);
            color: white;
            padding: 25px;
            border-radius: 15px;
            text-align: center;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        }

        .stat-number {
            font-size: 2.5em;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .stat-label {
            font-size: 0.9em;
            opacity: 0.9;
        }

        @media (max-width: 768px) {
            h1 {
                font-size: 1.8em;
            }

            .subtitle {
                font-size: 1em;
            }

            .tab-btn {
                min-width: 100%;
            }
        }
    </style>
</head>
<body>
    <div class="background-particles" id="particles"></div>

    <div class="container">
        <header>
            <h1>üîê Confidential Patent License Platform</h1>
            <p class="subtitle">Secure Patent Licensing with FHE Technology</p>

            <div class="wallet-section">
                <div class="wallet-info">
                    <span id="walletAddress">Not Connected</span>
                    <span id="networkInfo"></span>
                </div>
                <button id="connectWallet">Connect Wallet</button>
            </div>
        </header>

        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-number" id="totalPatents">0</div>
                <div class="stat-label">Total Patents</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="totalLicenses">0</div>
                <div class="stat-label">Total Licenses</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="myPatents">0</div>
                <div class="stat-label">My Patents</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="myLicenses">0</div>
                <div class="stat-label">My Licenses</div>
            </div>
        </div>

        <div class="tabs">
            <button class="tab-btn active" onclick="switchTab('register')">Register Patent</button>
            <button class="tab-btn" onclick="switchTab('license')">Request License</button>
            <button class="tab-btn" onclick="switchTab('bidding')">Confidential Bidding</button>
            <button class="tab-btn" onclick="switchTab('royalties')">Pay Royalties</button>
            <button class="tab-btn" onclick="switchTab('manage')">Manage</button>
            <button class="tab-btn" onclick="switchTab('view')">View All</button>
        </div>

        <div id="registerTab" class="tab-content active">
            <h2>Register New Patent</h2>
            <div class="success-message" id="registerSuccess"></div>
            <div class="error-message" id="registerError"></div>

            <div class="form-group">
                <label>Royalty Rate (basis points, max 10000 = 100%)</label>
                <input type="number" id="royaltyRate" placeholder="500 (5%)" value="500" min="0" max="10000" required>
            </div>
            <div class="form-group">
                <label>Minimum License Fee (ETH)</label>
                <input type="number" id="minLicenseFee" placeholder="1.0" value="1.0" step="0.01" required>
            </div>
            <div class="form-group">
                <label>Exclusivity Period (days)</label>
                <input type="number" id="exclusivityPeriod" placeholder="90" value="90" required>
            </div>
            <div class="form-group">
                <label>Validity Period (years)</label>
                <input type="number" id="validityYears" placeholder="5" value="5" min="1" max="20" required>
            </div>
            <div class="form-group">
                <label>Patent Hash (IPFS or document reference)</label>
                <input type="text" id="patentHash" placeholder="QmXxx..." value="QmPatentHash123456789" required>
            </div>
            <div class="form-group">
                <label>Territory Code</label>
                <input type="number" id="territoryCode" placeholder="1" value="1" min="0" max="255" required>
            </div>
            <div class="form-group">
                <label>
                    <input type="checkbox" id="isConfidential"> Keep terms confidential
                </label>
            </div>
            <button onclick="registerPatent()">Register Patent</button>
        </div>

        <div id="licenseTab" class="tab-content">
            <h2>Request License</h2>
            <div class="success-message" id="licenseSuccess"></div>
            <div class="error-message" id="licenseError"></div>

            <div class="form-group">
                <label>Patent ID</label>
                <input type="number" id="licensePatentId" placeholder="1" value="1" required>
            </div>
            <div class="form-group">
                <label>Proposed Fee (ETH)</label>
                <input type="number" id="proposedFee" placeholder="1.0" value="1.0" step="0.01" required>
            </div>
            <div class="form-group">
                <label>Proposed Royalty Rate (basis points)</label>
                <input type="number" id="proposedRoyaltyRate" placeholder="500" value="500" max="10000" required>
            </div>
            <div class="form-group">
                <label>Revenue Cap (ETH, 0 for unlimited)</label>
                <input type="number" id="revenueCap" placeholder="0" value="0" step="0.01" required>
            </div>
            <div class="form-group">
                <label>Duration (days)</label>
                <input type="number" id="licenseDuration" placeholder="365" value="365" required>
            </div>
            <div class="form-group">
                <label>Territory Mask</label>
                <input type="number" id="territoryMask" placeholder="255" value="255" min="0" max="255" required>
            </div>
            <div class="form-group">
                <label>
                    <input type="checkbox" id="requestExclusive"> Request Exclusive License
                </label>
            </div>
            <div class="form-group">
                <label>
                    <input type="checkbox" id="autoRenewal"> Enable Auto-Renewal
                </label>
            </div>
            <button onclick="requestLicense()">Request License</button>
        </div>

        <div id="biddingTab" class="tab-content">
            <h2>Confidential Bidding</h2>
            <div class="grid-2">
                <div>
                    <h3>Start Bidding (Patent Owners)</h3>
                    <div class="form-group">
                        <label>Patent ID</label>
                        <input type="number" id="biddingPatentId" placeholder="1">
                    </div>
                    <div class="form-group">
                        <label>Bidding Duration (hours, max 168)</label>
                        <input type="number" id="biddingDuration" placeholder="72" max="168">
                    </div>
                    <button onclick="startBidding()">Start Bidding</button>
                </div>
                <div>
                    <h3>Submit Bid</h3>
                    <div class="form-group">
                        <label>Patent ID</label>
                        <input type="number" id="bidPatentId" placeholder="1">
                    </div>
                    <div class="form-group">
                        <label>Bid Amount (ETH)</label>
                        <input type="number" id="bidAmount" placeholder="10.0" step="0.01">
                    </div>
                    <button onclick="submitBid()">Submit Confidential Bid</button>
                </div>
            </div>
            <div style="margin-top: 30px;">
                <h3>Finalize Bidding</h3>
                <div class="form-group">
                    <label>Patent ID</label>
                    <input type="number" id="finalizePatentId" placeholder="1">
                </div>
                <button onclick="finalizeBidding()">Finalize Bidding</button>
            </div>
        </div>

        <div id="royaltiesTab" class="tab-content">
            <h2>Pay Royalties</h2>
            <div class="success-message" id="royaltySuccess"></div>
            <div class="error-message" id="royaltyError"></div>

            <div class="form-group">
                <label>License ID</label>
                <input type="number" id="royaltyLicenseId" placeholder="1">
            </div>
            <div class="form-group">
                <label>Reported Revenue (ETH)</label>
                <input type="number" id="reportedRevenue" placeholder="100.0" step="0.01">
            </div>
            <div class="form-group">
                <label>Royalty Payment Amount (ETH)</label>
                <input type="number" id="royaltyAmount" placeholder="5.0" step="0.01">
            </div>
            <div class="form-group">
                <label>Reporting Period (timestamp or identifier)</label>
                <input type="number" id="reportingPeriod" placeholder="202401">
            </div>
            <button onclick="payRoyalties()">Pay Royalties</button>
        </div>

        <div id="manageTab" class="tab-content">
            <h2>Manage Patents & Licenses</h2>
            <div class="grid-2">
                <div>
                    <h3>Approve License</h3>
                    <div class="form-group">
                        <label>License ID</label>
                        <input type="number" id="approveLicenseId" placeholder="1">
                    </div>
                    <div class="form-group">
                        <label>Duration (days)</label>
                        <input type="number" id="approveDuration" placeholder="365">
                    </div>
                    <button onclick="approveLicense()">Approve License</button>
                </div>
                <div>
                    <h3>Update Patent Status</h3>
                    <div class="form-group">
                        <label>Patent ID</label>
                        <input type="number" id="updatePatentId" placeholder="1">
                    </div>
                    <div class="form-group">
                        <label>Status</label>
                        <select id="newPatentStatus">
                            <option value="0">Active</option>
                            <option value="1">Suspended</option>
                            <option value="2">Expired</option>
                        </select>
                    </div>
                    <button onclick="updatePatentStatus()">Update Status</button>
                </div>
            </div>
        </div>

        <div id="viewTab" class="tab-content">
            <h2>All Patents & Licenses</h2>
            <button onclick="loadAllData()" style="margin-bottom: 20px;">Refresh Data</button>

            <h3>My Patents</h3>
            <div id="myPatentsList"></div>

            <h3 style="margin-top: 30px;">My Licenses</h3>
            <div id="myLicensesList"></div>
        </div>
    </div>

    <script>
        const CONTRACT_ADDRESS = "0x6Cabd68b533F593D268344cB1281E50699001E0E";
        const ABI = [
            "function registerPatent(uint64 royaltyRate, uint64 minLicenseFee, uint32 exclusivityPeriod, uint256 validityYears, string calldata patentHash, uint8 territoryCode, bool isConfidential) external returns (uint256)",
            "function requestLicense(uint256 patentId, uint64 proposedFee, uint64 proposedRoyaltyRate, uint32 revenueCap, uint256 durationDays, bool requestExclusive, bool autoRenewal, uint8 territoryMask) external returns (uint256)",
            "function approveLicense(uint256 licenseId, uint256 durationDays) external",
            "function startConfidentialBidding(uint256 patentId, uint256 biddingDurationHours) external",
            "function submitConfidentialBid(uint256 patentId, uint64 bidAmount) external",
            "function finalizeBidding(uint256 patentId) external",
            "function payRoyalties(uint256 licenseId, uint64 reportedRevenue, uint256 reportingPeriod) external payable",
            "function updatePatentStatus(uint256 patentId, uint8 newStatus) external",
            "function nextPatentId() external view returns (uint256)",
            "function nextLicenseId() external view returns (uint256)",
            "function getUserPatents(address user) external view returns (uint256[])",
            "function getUserLicenses(address user) external view returns (uint256[])",
            "function getPatentInfo(uint256 patentId) external view returns (address patentOwner, uint256 registrationTime, uint256 expirationTime, uint8 status, bool isConfidential, string memory patentHash, uint8 territoryCode)",
            "event PatentRegistered(uint256 indexed patentId, address indexed owner, string patentHash)",
            "event LicenseRequested(uint256 indexed licenseId, uint256 indexed patentId, address indexed licensee)",
            "event LicenseApproved(uint256 indexed licenseId, address indexed licensee, address indexed licensor)",
            "event RoyaltyPaid(uint256 indexed licenseId, address indexed payer, uint256 reportingPeriod)"
        ];

        let provider;
        let signer;
        let contract;
        let userAddress;

        // Create background particles
        function createParticles() {
            const container = document.getElementById('particles');
            for (let i = 0; i < 30; i++) {
                const particle = document.createElement('div');
                particle.className = 'particle';
                particle.style.width = Math.random() * 80 + 20 + 'px';
                particle.style.height = particle.style.width;
                particle.style.left = Math.random() * 100 + '%';
                particle.style.top = Math.random() * 100 + '%';
                particle.style.animationDelay = Math.random() * 15 + 's';
                particle.style.animationDuration = Math.random() * 10 + 10 + 's';
                container.appendChild(particle);
            }
        }

        async function connectWallet() {
            try {
                if (typeof window.ethereum === 'undefined') {
                    alert('Please install MetaMask!');
                    return;
                }

                provider = new ethers.providers.Web3Provider(window.ethereum);
                await provider.send("eth_requestAccounts", []);
                signer = provider.getSigner();
                userAddress = await signer.getAddress();
                contract = new ethers.Contract(CONTRACT_ADDRESS, ABI, signer);

                document.getElementById('walletAddress').textContent =
                    userAddress.substring(0, 6) + '...' + userAddress.substring(38);

                const network = await provider.getNetwork();
                document.getElementById('networkInfo').textContent =
                    `Network: ${network.name}`;

                document.getElementById('connectWallet').textContent = 'Connected';
                document.getElementById('connectWallet').disabled = true;

                loadStats();
            } catch (error) {
                console.error('Error connecting wallet:', error);
                alert('Error connecting wallet: ' + error.message);
            }
        }

        async function loadStats() {
            try {
                const totalPatents = await contract.nextPatentId();
                const totalLicenses = await contract.nextLicenseId();
                const myPatents = await contract.getUserPatents(userAddress);
                const myLicenses = await contract.getUserLicenses(userAddress);

                document.getElementById('totalPatents').textContent = totalPatents - 1;
                document.getElementById('totalLicenses').textContent = totalLicenses - 1;
                document.getElementById('myPatents').textContent = myPatents.length;
                document.getElementById('myLicenses').textContent = myLicenses.length;
            } catch (error) {
                console.error('Error loading stats:', error);
            }
        }

        async function registerPatent() {
            if (!contract) {
                alert('Please connect your wallet first!');
                return;
            }
            try {
                const royaltyRate = document.getElementById('royaltyRate').value || '0';
                const minLicenseFeeValue = document.getElementById('minLicenseFee').value || '0';
                const exclusivityPeriod = document.getElementById('exclusivityPeriod').value || '0';
                const validityYears = document.getElementById('validityYears').value || '1';
                const patentHash = document.getElementById('patentHash').value || 'QmDefault';
                const territoryCode = document.getElementById('territoryCode').value || '0';
                const isConfidential = document.getElementById('isConfidential').checked;

                // Validate inputs
                if (!royaltyRate || royaltyRate === '' || isNaN(royaltyRate)) {
                    showMessage('registerError', 'Please enter a valid royalty rate');
                    return;
                }
                if (!minLicenseFeeValue || minLicenseFeeValue === '' || isNaN(minLicenseFeeValue)) {
                    showMessage('registerError', 'Please enter a valid minimum license fee');
                    return;
                }

                const minLicenseFee = ethers.utils.parseEther(minLicenseFeeValue);

                const tx = await contract.registerPatent(
                    royaltyRate, minLicenseFee, exclusivityPeriod, validityYears,
                    patentHash, territoryCode, isConfidential
                );

                showMessage('registerSuccess', 'Transaction submitted! Waiting for confirmation...');
                await tx.wait();
                showMessage('registerSuccess', 'Patent registered successfully!');
                loadStats();
            } catch (error) {
                console.error('Error registering patent:', error);
                showMessage('registerError', 'Error: ' + error.message);
            }
        }

        async function requestLicense() {
            if (!contract) {
                alert('Please connect your wallet first!');
                return;
            }
            try {
                const patentId = document.getElementById('licensePatentId').value;
                const proposedFee = ethers.utils.parseEther(document.getElementById('proposedFee').value);
                const proposedRoyaltyRate = document.getElementById('proposedRoyaltyRate').value;
                const revenueCap = ethers.utils.parseEther(document.getElementById('revenueCap').value);
                const durationDays = document.getElementById('licenseDuration').value;
                const requestExclusive = document.getElementById('requestExclusive').checked;
                const autoRenewal = document.getElementById('autoRenewal').checked;
                const territoryMask = document.getElementById('territoryMask').value;

                const tx = await contract.requestLicense(
                    patentId, proposedFee, proposedRoyaltyRate, revenueCap,
                    durationDays, requestExclusive, autoRenewal, territoryMask
                );

                showMessage('licenseSuccess', 'Transaction submitted! Waiting for confirmation...');
                await tx.wait();
                showMessage('licenseSuccess', 'License requested successfully!');
                loadStats();
            } catch (error) {
                console.error('Error requesting license:', error);
                showMessage('licenseError', 'Error: ' + error.message);
            }
        }

        async function startBidding() {
            if (!contract) {
                alert('Please connect your wallet first!');
                return;
            }
            try {
                const patentId = document.getElementById('biddingPatentId').value;
                const duration = document.getElementById('biddingDuration').value;

                const tx = await contract.startConfidentialBidding(patentId, duration);
                await tx.wait();
                alert('Bidding started successfully!');
            } catch (error) {
                console.error('Error starting bidding:', error);
                alert('Error: ' + error.message);
            }
        }

        async function submitBid() {
            if (!contract) {
                alert('Please connect your wallet first!');
                return;
            }
            try {
                const patentId = document.getElementById('bidPatentId').value;
                const bidAmount = ethers.utils.parseEther(document.getElementById('bidAmount').value);

                const tx = await contract.submitConfidentialBid(patentId, bidAmount);
                await tx.wait();
                alert('Bid submitted successfully!');
            } catch (error) {
                console.error('Error submitting bid:', error);
                alert('Error: ' + error.message);
            }
        }

        async function finalizeBidding() {
            if (!contract) {
                alert('Please connect your wallet first!');
                return;
            }
            try {
                const patentId = document.getElementById('finalizePatentId').value;
                const tx = await contract.finalizeBidding(patentId);
                await tx.wait();
                alert('Bidding finalized successfully!');
                loadStats();
            } catch (error) {
                console.error('Error finalizing bidding:', error);
                alert('Error: ' + error.message);
            }
        }

        async function payRoyalties() {
            if (!contract) {
                alert('Please connect your wallet first!');
                return;
            }
            try {
                const licenseId = document.getElementById('royaltyLicenseId').value;
                const reportedRevenue = ethers.utils.parseEther(document.getElementById('reportedRevenue').value);
                const royaltyAmount = ethers.utils.parseEther(document.getElementById('royaltyAmount').value);
                const reportingPeriod = document.getElementById('reportingPeriod').value;

                const tx = await contract.payRoyalties(licenseId, reportedRevenue, reportingPeriod, {
                    value: royaltyAmount
                });

                showMessage('royaltySuccess', 'Transaction submitted! Waiting for confirmation...');
                await tx.wait();
                showMessage('royaltySuccess', 'Royalty payment successful!');
            } catch (error) {
                console.error('Error paying royalties:', error);
                showMessage('royaltyError', 'Error: ' + error.message);
            }
        }

        async function approveLicense() {
            if (!contract) {
                alert('Please connect your wallet first!');
                return;
            }
            try {
                const licenseId = document.getElementById('approveLicenseId').value;
                const duration = document.getElementById('approveDuration').value;

                const tx = await contract.approveLicense(licenseId, duration);
                await tx.wait();
                alert('License approved successfully!');
                loadStats();
            } catch (error) {
                console.error('Error approving license:', error);
                alert('Error: ' + error.message);
            }
        }

        async function updatePatentStatus() {
            if (!contract) {
                alert('Please connect your wallet first!');
                return;
            }
            try {
                const patentId = document.getElementById('updatePatentId').value;
                const status = document.getElementById('newPatentStatus').value;

                const tx = await contract.updatePatentStatus(patentId, status);
                await tx.wait();
                alert('Patent status updated successfully!');
            } catch (error) {
                console.error('Error updating patent status:', error);
                alert('Error: ' + error.message);
            }
        }

        async function loadAllData() {
            if (!contract) {
                alert('Please connect your wallet first!');
                return;
            }
            try {
                const myPatents = await contract.getUserPatents(userAddress);
                const myLicenses = await contract.getUserLicenses(userAddress);

                let patentsHTML = '';
                for (let id of myPatents) {
                    try {
                        const info = await contract.getPatentInfo(id);
                        const statusNames = ['Active', 'Suspended', 'Expired'];
                        patentsHTML += `
                            <div class="card">
                                <h3>Patent #${id}</h3>
                                <div class="card-content">
                                    <div class="info-item">
                                        <div class="info-label">Status</div>
                                        <div class="info-value">
                                            <span class="status-badge status-${statusNames[info[3]].toLowerCase()}">
                                                ${statusNames[info[3]]}
                                            </span>
                                        </div>
                                    </div>
                                    <div class="info-item">
                                        <div class="info-label">Patent Hash</div>
                                        <div class="info-value">${info[5]}</div>
                                    </div>
                                    <div class="info-item">
                                        <div class="info-label">Confidential</div>
                                        <div class="info-value">${info[4] ? 'Yes' : 'No'}</div>
                                    </div>
                                    <div class="info-item">
                                        <div class="info-label">Territory Code</div>
                                        <div class="info-value">${info[6]}</div>
                                    </div>
                                </div>
                            </div>
                        `;
                    } catch (e) {
                        console.error(`Error loading patent ${id}:`, e);
                    }
                }
                document.getElementById('myPatentsList').innerHTML = patentsHTML || '<p>No patents found</p>';

                let licensesHTML = '';
                for (let id of myLicenses) {
                    licensesHTML += `
                        <div class="card">
                            <h3>License #${id}</h3>
                            <div class="card-content">
                                <div class="info-item">
                                    <div class="info-label">License ID</div>
                                    <div class="info-value">${id}</div>
                                </div>
                            </div>
                        </div>
                    `;
                }
                document.getElementById('myLicensesList').innerHTML = licensesHTML || '<p>No licenses found</p>';

            } catch (error) {
                console.error('Error loading data:', error);
            }
        }

        function switchTab(tabName) {
            const tabs = document.querySelectorAll('.tab-content');
            tabs.forEach(tab => tab.classList.remove('active'));

            const buttons = document.querySelectorAll('.tab-btn');
            buttons.forEach(btn => btn.classList.remove('active'));

            document.getElementById(tabName + 'Tab').classList.add('active');
            event.target.classList.add('active');
        }

        function showMessage(elementId, message) {
            const element = document.getElementById(elementId);
            element.textContent = message;
            element.style.display = 'block';
            setTimeout(() => {
                element.style.display = 'none';
            }, 5000);
        }

        // Initialize
        createParticles();
        document.getElementById('connectWallet').addEventListener('click', connectWallet);
    </script>
</body>
</html>
